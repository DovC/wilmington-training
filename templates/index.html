
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wilmington Half Marathon Training Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .calendar-day {
            min-height: 120px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-900 to-blue-700 rounded-lg shadow-xl p-8 mb-8 text-white">
            <div class="flex justify-between items-start mb-4">
                <h1 class="text-4xl font-bold">üèÉ Wilmington Half Marathon Training</h1>
                <div id="strava-status" class="text-sm">
                    <!-- Strava connection status will load here -->
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-sm opacity-90">Race Date</div>
                    <div class="text-xl font-bold">February 28, 2026</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-sm opacity-90">Goal Time</div>
                    <div class="text-xl font-bold">Sub 1:50:00</div>
                </div>
                <div class="bg-white bg-opacity-20 rounded-lg p-4">
                    <div class="text-sm opacity-90">Goal Pace</div>
                    <div class="text-xl font-bold">8:20-8:25/mile</div>
                </div>
            </div>
        </header>

        <!-- Stats Dashboard - New 3 Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
            <!-- LEFT COLUMN: Stats (25% width = 1 col) -->
            <div class="space-y-4">
                <div class="bg-gradient-to-br from-blue-900 to-blue-700 rounded-lg shadow-lg p-6 text-white">
                    <div class="text-sm mb-2 opacity-90">Workouts Completed</div>
                    <div id="stat-workouts" class="text-4xl font-bold">0 / 0</div>
                </div>
                <div class="bg-gradient-to-br from-blue-800 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                    <div class="text-sm mb-2 opacity-90">Miles Completed</div>
                    <div id="stat-miles" class="text-4xl font-bold">0</div>
                </div>
                <div class="bg-gradient-to-br from-blue-700 to-blue-500 rounded-lg shadow-lg p-6 text-white">
                    <div class="text-sm mb-2 opacity-90">Weeks to Race</div>
                    <div id="stat-weeks" class="text-4xl font-bold">13</div>
                </div>
            </div>

            <!-- MIDDLE COLUMN: Pacing Guide (25% width = 1 col) -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üéØ Target Paces</h3>
                <div class="space-y-3">
                    <div class="border-b border-gray-200 pb-3">
                        <div class="text-xs font-semibold text-gray-500 uppercase">Easy</div>
                        <div class="text-lg font-bold text-gray-900">9:45-10:30</div>
                    </div>
                    <div class="border-b border-gray-200 pb-3">
                        <div class="text-xs font-semibold text-gray-500 uppercase">Tempo</div>
                        <div class="text-lg font-bold text-gray-900">8:05-8:15</div>
                    </div>
                    <div class="border-b border-gray-200 pb-3">
                        <div class="text-xs font-semibold text-gray-500 uppercase">800m</div>
                        <div class="text-lg font-bold text-gray-900">3:00-3:04</div>
                        <div class="text-xs text-gray-500">(7:30-7:40 pace)</div>
                    </div>
                    <div class="border-b border-gray-200 pb-3">
                        <div class="text-xs font-semibold text-gray-500 uppercase">Race Pace</div>
                        <div class="text-lg font-bold text-blue-600">8:20-8:25</div>
                    </div>
                    <div class="border-b border-gray-200 pb-3">
                        <div class="text-xs font-semibold text-gray-500 uppercase">Long Run</div>
                        <div class="text-lg font-bold text-gray-900">9:30-10:00</div>
                    </div>
                    <div class="pb-1">
                        <div class="text-xs font-semibold text-gray-500 uppercase">Strides</div>
                        <div class="text-lg font-bold text-gray-900">6:15-6:30</div>
                        <div class="text-xs text-gray-500">(20 sec)</div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Weekly Mileage Chart (50% width = 2 cols) -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üìà Planned vs Actual</h3>
                <canvas id="weeklyMileageChart"></canvas>
            </div>
        </div>

        <!-- Color Legend -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="text-sm font-semibold text-gray-700 mb-3">Color Key:</div>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded bg-yellow-100 border border-gray-300 mr-2"></div>
                    <span class="text-sm text-gray-700">Rest Day</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded bg-green-50 border border-gray-300 mr-2"></div>
                    <span class="text-sm text-gray-700">Easy Run</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded bg-pink-100 border border-gray-300 mr-2"></div>
                    <span class="text-sm text-gray-700">Quality Workout</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded bg-blue-100 border border-gray-300 mr-2"></div>
                    <span class="text-sm text-gray-700">Long Run</span>
                </div>
                <div class="flex items-center">
                    <div class="w-6 h-6 rounded bg-green-100 border border-green-500 mr-2"></div>
                    <span class="text-sm text-gray-700">Completed</span>
                </div>
            </div>
        </div>

        <!-- View Toggle and Initialize -->
        <div class="flex justify-between items-center mb-6">
            <div class="flex space-x-4">
                <button onclick="changeView('calendar')" id="btn-calendar" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition">
                    üìÖ Calendar View
                </button>
                <button onclick="changeView('list')" id="btn-list" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold shadow hover:bg-gray-300 transition">
                    üìã List View
                </button>
            </div>
            <div class="flex space-x-4">
                <button onclick="resetPlan()" class="px-6 py-3 bg-red-600 text-white rounded-lg font-semibold shadow-lg hover:bg-red-700 transition">
                    üîÑ Reset Plan (QA)
                </button>
                <button onclick="initializePlan()" class="px-6 py-3 bg-green-600 text-white rounded-lg font-semibold shadow-lg hover:bg-green-700 transition">
                    üîÉ Refresh View
                </button>
            </div>
        </div>

        <!-- Training Plan Container -->
        <div id="training-plan-container" class="bg-white rounded-lg shadow-xl p-6">
            <div class="text-center text-gray-500 py-12">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-xl font-semibold">Click "Initialize Training Plan" to begin</p>
            </div>
        </div>
    </div>

    <!-- Workout Modal -->
    <div id="workout-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Log Workout</h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                </div>
                
                <div id="modal-workout-info" class="bg-blue-50 rounded-lg p-4 mb-6"></div>
                
                <form id="workout-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Actual Distance (miles)</label>
                        <input type="number" id="actual-distance" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., 6.2" oninput="calculatePace()">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Duration (MM:SS or HH:MM:SS)</label>
                        <input type="text" id="duration" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., 52:30 or 1:25:45" oninput="calculatePace()">
                        <p class="text-xs text-gray-500 mt-1">Enter time as MM:SS (52:30) or HH:MM:SS (1:25:45)</p>
                    </div>
                    
                    <!-- Pace Calculator Display -->
                    <div id="pace-calculator" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-sm text-gray-600">Calculated Pace</div>
                                <div id="calculated-pace" class="text-2xl font-bold text-blue-900"></div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-600">Total Time</div>
                                <div id="calculated-time" class="text-lg font-semibold text-gray-800"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="workout-notes" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="How did it feel? Weather? Any observations..."></textarea>
                    </div>
                    
                    <div class="flex space-x-4 pt-4">
                        <button type="button" onclick="saveWorkout()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            üíæ Save Workout
                        </button>
                        <button type="button" onclick="closeModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‚úèÔ∏è Edit Workout</h2>
                    <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
                </div>
                
                <div id="edit-workout-info" class="bg-blue-50 rounded-lg p-4 mb-6"></div>
                
                <!-- Original Workout (Always Shown) -->
                <div class="bg-gray-100 rounded-lg p-4 mb-6">
                    <div class="text-sm font-semibold text-gray-700 mb-2">üìã Original Planned Workout:</div>
                    <div id="original-workout-display" class="text-gray-900"></div>
                </div>
                
                <form id="edit-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Modified Workout Description</label>
                        <input type="text" id="modified-workout" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., 6 mi Easy (tired from travel)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Planned Distance (miles)</label>
                        <input type="number" id="modified-miles" step="0.1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0 for rest day">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Workout Type</label>
                        <select id="modified-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="easy">Easy Run</option>
                            <option value="quality">Quality Workout (Tempo/Intervals)</option>
                            <option value="long">Long Run</option>
                            <option value="recovery">Recovery Run</option>
                            <option value="rest">Rest Day</option>
                            <option value="race">Race/Time Trial</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Change (optional)</label>
                        <textarea id="modification-reason" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Traveling, feeling tired, weather, etc."></textarea>
                    </div>
                    
                    <div class="flex space-x-3 pt-4">
                        <button type="button" onclick="saveWorkoutEdit()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
                            üíæ Save Changes
                        </button>
                        <button type="button" onclick="revertToOriginal()" class="flex-1 bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition">
                            ‚Ü©Ô∏è Revert
                        </button>
                        <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let trainingPlan = null;
        let completedWorkouts = {};
        let currentView = 'calendar';
        let currentWorkoutDate = null;
        let currentStats = null;  // Store stats globally for chart access

        // Initialize the training plan
        async function initializePlan() {
            try {
                // Fetch training plan structure from API
                const planResponse = await fetch('/api/get_plan');
                trainingPlan = await planResponse.json();
                
                // Fetch CURRENT workout data from Firestore (real-time)
                const workoutsResponse = await fetch('/api/get_workouts');
                completedWorkouts = await workoutsResponse.json();
                
                // Fetch current stats from backend and store globally
                const statsResponse = await fetch('/api/get_stats');
                currentStats = await statsResponse.json();
                updateStats(currentStats);
                
                renderView();
            } catch (error) {
                console.error('Error initializing plan:', error);
                alert('Error loading training plan. Please try again.');
            }
        }

        // Reset all workout data (QA/testing)
        async function resetPlan() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL logged workouts!\n\nAre you sure you want to reset the entire plan?')) {
                return;
            }
            
            // Double confirmation
            if (!confirm('This action cannot be undone. Really reset everything?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/reset_plan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ ${result.message}`);
                    
                    // Clear local data
                    completedWorkouts = {};
                    
                    // Update stats FIRST
                    await updateStatsFromAPI();
                    
                    // THEN refresh the view
                    renderView();
                } else {
                    alert('‚ùå Error resetting plan: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error resetting plan:', error);
                alert('‚ùå Error resetting plan. Please try again.');
            }
        }

        // Change view between calendar and list
        function changeView(view) {
            currentView = view;
            
            document.getElementById('btn-calendar').className = view === 'calendar' ?
                'px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition' :
                'px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold shadow hover:bg-gray-300 transition';
            
            document.getElementById('btn-list').className = view === 'list' ?
                'px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-lg hover:bg-blue-700 transition' :
                'px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold shadow hover:bg-gray-300 transition';
            
            renderView();
        }

        // Render current view
        function renderView() {
            if (!trainingPlan) return;
            
            if (currentView === 'calendar') {
                renderCalendarView();
            } else {
                renderListView();
            }
        }

        // Render calendar view
        function renderCalendarView() {
            const container = document.getElementById('training-plan-container');
            let html = '';
            let dayCounter = 1;
            
            trainingPlan.weeks.forEach(week => {
                // Calculate actual miles for this week
                let weekActualMiles = 0;
                if (currentStats && currentStats.weekly_actual_miles) {
                    weekActualMiles = currentStats.weekly_actual_miles[week.week_num - 1] || 0;
                }
                
                html += `
                    <div class="mb-8">
                        <div class="bg-gradient-to-r from-blue-900 to-blue-700 text-white rounded-t-lg p-4">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-xl font-bold">Week ${week.week_num}: ${week.dates}</h3>
                                    <p class="text-sm opacity-90">${week.phase}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold">${weekActualMiles.toFixed(1)} / ${week.total_miles} miles</div>
                                    <div class="text-sm opacity-90">${week.num_runs} runs</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-7 gap-2 p-4 bg-gray-50 rounded-b-lg">
                `;
                
                week.workouts.forEach((workout, idx) => {
                    const key = `w${week.week_num}_d${idx}`;
                    const workoutData = completedWorkouts[key] || {};
                    const isCompleted = workoutData.completed;
                    const isModified = workoutData.is_modified;
                    
                    // Use modified workout if it exists, otherwise use original
                    const currentWorkout = isModified ? workoutData.modified_workout : workout.workout;
                    const currentMiles = isModified ? workoutData.modified_miles : workout.miles;
                    const isRest = currentMiles === 0;
                    
                    // Determine workout type for coloring
                    const workoutLower = currentWorkout.toLowerCase();
                    const isQuality = workoutLower.includes('tempo') || workoutLower.includes('interval') || 
                                     workoutLower.includes('sharpener') || workoutLower.includes('tune-up');
                    const isLong = currentMiles >= 8;
                    const isEasy = workoutLower.includes('easy') && !isLong;
                    
                    // Set background color based on workout type
                    let bgColor = 'bg-white';
                    if (isCompleted) {
                        bgColor = 'bg-green-100';
                    } else if (isRest) {
                        bgColor = 'bg-yellow-100';
                    } else if (isQuality) {
                        bgColor = 'bg-pink-100';
                    } else if (isLong) {
                        bgColor = 'bg-blue-100';
                    } else if (isEasy) {
                        bgColor = 'bg-green-50';
                    }
                    
                    let dayClass = `calendar-day ${bgColor}`;
                    // Add orange left border for modified workouts
                    let borderStyle = isModified ? 'border-l-4 border-l-orange-500' : '';
                    
                    // Add goal pace for Easy and Long runs (if not modified and not completed)
                    let paceInfo = '';
                    if (isEasy && !isCompleted && !isModified) {
                        paceInfo = '<div class="text-xs text-gray-600 mt-1">@ 9:45-10:30</div>';
                    } else if (isLong && !isCompleted && !isModified && !workoutLower.includes('@')) {
                        paceInfo = '<div class="text-xs text-gray-600 mt-1">@ 9:30-10:00</div>';
                    }
                    
                    html += `
                        <div class="${dayClass} ${borderStyle} rounded-lg p-3 relative flex flex-col min-h-[140px]">
                            ${isModified ? '<div class="absolute top-1 right-1 text-orange-500 text-lg">‚úèÔ∏è</div>' : ''}
                            <div class="flex-grow">
                                <div class="font-bold text-sm text-gray-700 mb-1">${workout.day}</div>
                                ${isModified ? '<div class="text-xs font-bold text-orange-600 mb-1">MODIFIED</div>' : ''}
                                <div class="text-sm font-semibold ${isRest ? 'text-amber-700' : 'text-gray-900'}">
                                    ${isCompleted ? '‚úÖ ' : ''}${currentWorkout}
                                </div>
                                ${currentMiles > 0 ? `<div class="text-xs text-indigo-600 font-bold mt-2">${currentMiles} mi</div>` : ''}
                                ${paceInfo}
                                ${isCompleted && workoutData.actual_miles ? `
                                    <div class="text-xs text-green-700 mt-2 font-semibold">
                                        ‚úì ${workoutData.actual_miles} mi logged
                                    </div>
                                    ${workoutData.duration ? `
                                        <div class="text-xs text-gray-600 mt-1">
                                            ‚è±Ô∏è ${workoutData.duration}
                                        </div>
                                    ` : ''}
                                    ${workoutData.actual_pace ? `
                                        <div class="text-xs text-gray-600">
                                            üìä ${workoutData.actual_pace}
                                        </div>
                                    ` : ''}
                                ` : ''}
                            </div>
                             <div class="mt-2 space-y-1">
    ${(!isRest || isModified) || !isRest ? `
        <div class="flex gap-1">
            ${!isRest || isModified ? `
                <button onclick="openModal(${week.week_num}, ${idx}, '${workout.day}', '${currentWorkout.replace(/'/g, "\\'")}');" 
                    class="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex-1">
                    Log
                </button>
            ` : ''}
            ${!isRest ? `
                <button onclick="importFromStrava('${workout.day}', ${week.week_num}, ${idx});" 
                    class="text-xs px-2 py-1 bg-orange-500 text-white rounded hover:bg-orange-600 flex-1 flex items-center justify-center gap-1" 
                    title="Import from Strava">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                    </svg>
                    Strava
                </button>
            ` : ''}
        </div>
    ` : ''}
    <button onclick="openEditModal(${week.week_num}, ${idx}, '${workout.day}', ${JSON.stringify(workout).replace(/"/g, '&quot;')});" 
        class="text-xs px-2 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 w-full">
        Edit
    </button>
</div>
                        </div>
                    `;
                    dayCounter++;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Render list view
        function renderListView() {
            const container = document.getElementById('training-plan-container');
            let dayCounter = 1;
            let html = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Day</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Workout</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Planned Miles</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            trainingPlan.weeks.forEach(week => {
                week.workouts.forEach((workout, idx) => {
                    const key = `w${week.week_num}_d${idx}`;
                    const workoutData = completedWorkouts[key] || {};
                    const isCompleted = workoutData.completed;
                    const isModified = workoutData.is_modified;
                    
                    // Use modified workout if exists
                    const currentWorkout = isModified ? workoutData.modified_workout : workout.workout;
                    const currentMiles = isModified ? workoutData.modified_miles : workout.miles;
                    const isRest = currentMiles === 0;
                    
                    // Determine row background color
                    const workoutLower = currentWorkout.toLowerCase();
                    const isQuality = workoutLower.includes('tempo') || workoutLower.includes('interval') || 
                                     workoutLower.includes('sharpener') || workoutLower.includes('tune-up');
                    const isLong = currentMiles >= 8;
                    const isEasy = workoutLower.includes('easy') && !isLong;
                    
                    let rowBg = '';
                    if (isCompleted) {
                        rowBg = 'bg-green-50';
                    } else if (isRest) {
                        rowBg = 'bg-yellow-50';
                    } else if (isQuality) {
                        rowBg = 'bg-pink-50';
                    } else if (isLong) {
                        rowBg = 'bg-blue-50';
                    } else if (isEasy) {
                        rowBg = 'bg-green-25';
                    }
                    
                    // Add orange border for modified
                    let borderStyle = isModified ? 'border-l-4 border-l-orange-500' : '';
                    
                    html += `
                        <tr class="hover:bg-gray-50 ${rowBg} ${borderStyle}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-700">${isModified ? '‚úèÔ∏è ' : ''}${dayCounter}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${workout.day}</td>
                            <td class="px-6 py-4 text-sm text-gray-900">
                                ${isModified ? '<span class="text-orange-600 font-semibold text-xs">MODIFIED:</span><br>' : ''}
                                ${currentWorkout}
                                ${isModified ? `<br><span class="text-xs text-gray-500">Original: ${workout.workout}</span>` : ''}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${currentMiles || '-'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                ${isCompleted ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">‚úÖ Completed</span>' :
                                  isModified ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">‚úèÔ∏è Modified</span>' :
                                  isRest ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Rest</span>' :
                                  '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Planned</span>'}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm flex gap-2">
                                ${!isRest || isModified ? `<button onclick="openModal(${week.week_num}, ${idx}, '${workout.day} (${dayCounter})', '${currentWorkout.replace(/'/g, "\\'")}') " class="text-blue-600 hover:text-blue-900 font-semibold">Log</button>` : ''}
                                <button onclick="openEditModal(${week.week_num}, ${idx}, '${workout.day} (${dayCounter})', ${JSON.stringify(workout).replace(/"/g, '&quot;')})" class="text-gray-600 hover:text-gray-900 font-semibold">Edit</button>
                            </td>
                        </tr>
                    `;
                    dayCounter++;
                });
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Open workout modal
        function openModal(week, day, dayStr, workout) {
            currentWorkoutDate = {week, day};
            document.getElementById('modal-workout-info').innerHTML = `
                <p class="text-lg font-semibold text-gray-800">${dayStr}</p>
                <p class="text-gray-600 mt-1">${workout}</p>
            `;
            
            // Load existing data if any
            const key = `w${week}_d${day}`;
            if (completedWorkouts[key]) {
                document.getElementById('actual-distance').value = completedWorkouts[key].actual_miles || '';
                document.getElementById('duration').value = completedWorkouts[key].duration || '';
                document.getElementById('workout-notes').value = completedWorkouts[key].notes || '';
                calculatePace(); // Show pace for existing workout
            } else {
                document.getElementById('actual-distance').value = '';
                document.getElementById('duration').value = '';
                document.getElementById('workout-notes').value = '';
                document.getElementById('pace-calculator').classList.add('hidden');
            }
            
            document.getElementById('workout-modal').classList.remove('hidden');
        }

        // Close modal
        // Calculate and display pace as user types
        function calculatePace() {
            const distance = parseFloat(document.getElementById('actual-distance').value);
            const durationInput = document.getElementById('duration').value.trim();
            const paceCalculator = document.getElementById('pace-calculator');
            
            // Only show if both fields have values
            if (!distance || !durationInput || distance <= 0) {
                paceCalculator.classList.add('hidden');
                return;
            }
            
            // Parse duration
            const timePattern = /^(?:(\d+):)?(\d{1,2}):(\d{2})$/;
            const match = durationInput.match(timePattern);
            
            if (!match) {
                paceCalculator.classList.add('hidden');
                return;
            }
            
            const hours = match[1] ? parseInt(match[1]) : 0;
            const minutes = parseInt(match[2]);
            const seconds = parseInt(match[3]);
            
            if (minutes >= 60 || seconds >= 60) {
                paceCalculator.classList.add('hidden');
                return;
            }
            
            // Convert to total minutes
            const totalMinutes = hours * 60 + minutes + seconds / 60;
            
            // Calculate pace (min/mile)
            const paceMinutes = totalMinutes / distance;
            const paceMin = Math.floor(paceMinutes);
            const paceSec = Math.round((paceMinutes - paceMin) * 60);
            
            // Format pace
            const paceFormatted = `${paceMin}:${paceSec.toString().padStart(2, '0')} min/mi`;
            
            // Format total time
            const totalHours = Math.floor(totalMinutes / 60);
            const totalMins = Math.floor(totalMinutes % 60);
            const totalSecs = Math.round((totalMinutes % 1) * 60);
            let timeFormatted = '';
            if (totalHours > 0) {
                timeFormatted = `${totalHours}:${totalMins.toString().padStart(2, '0')}:${totalSecs.toString().padStart(2, '0')}`;
            } else {
                timeFormatted = `${totalMins}:${totalSecs.toString().padStart(2, '0')}`;
            }
            
            // Display
            document.getElementById('calculated-pace').textContent = paceFormatted;
            document.getElementById('calculated-time').textContent = timeFormatted;
            paceCalculator.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('workout-modal').classList.add('hidden');
            currentWorkoutDate = null;
        }

        // Save workout
        async function saveWorkout() {
            if (!currentWorkoutDate) return;
            
            const actualMiles = document.getElementById('actual-distance').value;
            const durationInput = document.getElementById('duration').value.trim();
            const notes = document.getElementById('workout-notes').value;
            
            // Validate and parse duration (MM:SS or HH:MM:SS)
            let durationMinutes = null;
            if (durationInput) {
                const timePattern = /^(?:(\d+):)?(\d{1,2}):(\d{2})$/;
                const match = durationInput.match(timePattern);
                
                if (!match) {
                    alert('‚ö†Ô∏è Invalid duration format. Please use MM:SS (e.g., 52:30) or HH:MM:SS (e.g., 1:25:45)');
                    return;
                }
                
                const hours = match[1] ? parseInt(match[1]) : 0;
                const minutes = parseInt(match[2]);
                const seconds = parseInt(match[3]);
                
                if (minutes >= 60 || seconds >= 60) {
                    alert('‚ö†Ô∏è Invalid time. Minutes and seconds must be less than 60.');
                    return;
                }
                
                // Convert to total minutes (decimal)
                durationMinutes = hours * 60 + minutes + seconds / 60;
            }
            
            // Calculate pace in MM:SS format
            let actualPace = '';
            if (actualMiles && durationMinutes) {
                const paceMinutes = durationMinutes / parseFloat(actualMiles);
                const paceMin = Math.floor(paceMinutes);
                const paceSec = Math.round((paceMinutes - paceMin) * 60);
                actualPace = `${paceMin}:${paceSec.toString().padStart(2, '0')} min/mi`;
            }
            
            try {
                const response = await fetch('/api/log_workout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        week: currentWorkoutDate.week,
                        day: currentWorkoutDate.day,
                        completed: true,
                        actual_miles: actualMiles,
                        actual_pace: actualPace,
                        notes: notes,
                        duration: durationInput  // Store original format
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local data
                    const key = `w${currentWorkoutDate.week}_d${currentWorkoutDate.day}`;
                    completedWorkouts[key] = result.data;
                    
                    // Update stats FIRST (so weekly totals are correct)
                    await updateStatsFromAPI();
                    
                    // THEN refresh view with updated stats
                    renderView();
                    closeModal();
                } else {
                    alert('Error saving workout: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving workout:', error);
                alert('Error saving workout. Please try again.');
            }
        }

        // Update stats from API
        async function updateStatsFromAPI() {
            try {
                const response = await fetch('/api/get_stats');
                currentStats = await response.json();
                updateStats(currentStats);
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Update stats display
        function updateStats(stats) {
            document.getElementById('stat-workouts').textContent = `${stats.completed_workouts} / ${stats.total_workouts}`;
            document.getElementById('stat-miles').textContent = stats.completed_miles;
            updateWeeklyChart();
        }

        // Chart.js instance
        let weeklyChart = null;

        // Create/Update Weekly Mileage Chart
        function updateWeeklyChart() {
            const ctx = document.getElementById('weeklyMileageChart');
            if (!ctx) return;

            // Use weekly breakdown from API (single source of truth)
            const weeklyActual = currentStats ? currentStats.weekly_actual_miles : Array(13).fill(0);

            // Get planned miles per week from training plan
            const weeklyPlanned = trainingPlan.weeks.map(week => week.total_miles);
            const weekLabels = Array.from({length: 13}, (_, i) => (i + 1).toString());

            // Destroy existing chart if it exists
            if (weeklyChart) {
                weeklyChart.destroy();
            }

            // Create new chart
            weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: weekLabels,
                    datasets: [
                        {
                            label: 'Planned',
                            data: weeklyPlanned,
                            backgroundColor: 'rgba(33, 150, 243, 0.8)', // Marathon Blue
                            borderColor: 'rgba(33, 150, 243, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Actual',
                            data: weeklyActual,
                            backgroundColor: 'rgba(255, 107, 107, 0.8)', // Coral
                            borderColor: 'rgba(255, 107, 107, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 15,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' miles';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Week',
                                font: {
                                    size: 14
                                }
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            max: 50,
                            ticks: {
                                stepSize: 10
                            },
                            title: {
                                display: false
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Initialize on page load
        window.addEventListener('load', initializePlan);
        
        // Edit workout functionality
        let currentEditWorkout = null;

        // Open edit modal
        function openEditModal(week, day, dayStr, workout) {
            currentEditWorkout = {week, day, workout};
            
            const key = `w${week}_d${day}`;
            const workoutData = completedWorkouts[key] || {};
            
            // Display day info
            document.getElementById('edit-workout-info').innerHTML = `
                <p class="text-lg font-semibold text-gray-800">${dayStr}</p>
                <p class="text-sm text-gray-600 mt-1">${workout.day_type}</p>
            `;
            
            // Display original workout
            document.getElementById('original-workout-display').innerHTML = `
                <div class="font-semibold">${workout.workout}</div>
                <div class="text-sm text-gray-600 mt-1">Distance: ${workout.miles} miles</div>
            `;
            
            // Pre-fill with modified values if exists, otherwise original
            if (workoutData.is_modified) {
                document.getElementById('modified-workout').value = workoutData.modified_workout || '';
                document.getElementById('modified-miles').value = workoutData.modified_miles || '';
                document.getElementById('modified-type').value = workoutData.modified_type || 'easy';
                document.getElementById('modification-reason').value = workoutData.modification_reason || '';
            } else {
                document.getElementById('modified-workout').value = workout.workout;
                document.getElementById('modified-miles').value = workout.miles;
                // Auto-detect type
                const workoutLower = workout.workout.toLowerCase();
                let detectedType = 'easy';
                if (workout.miles === 0) detectedType = 'rest';
                else if (workout.miles >= 8) detectedType = 'long';
                else if (workoutLower.includes('tempo') || workoutLower.includes('interval')) detectedType = 'quality';
                else if (workoutLower.includes('recovery')) detectedType = 'recovery';
                document.getElementById('modified-type').value = detectedType;
                document.getElementById('modification-reason').value = '';
            }
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            currentEditWorkout = null;
        }

        // Save workout edit
        async function saveWorkoutEdit() {
            if (!currentEditWorkout) return;
            
            const modifiedWorkout = document.getElementById('modified-workout').value.trim();
            const modifiedMiles = parseFloat(document.getElementById('modified-miles').value) || 0;
            const modifiedType = document.getElementById('modified-type').value;
            const modificationReason = document.getElementById('modification-reason').value.trim();
            
            if (!modifiedWorkout) {
                alert('Please enter a workout description');
                return;
            }
            
            try {
                const response = await fetch('/api/edit_workout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        week: currentEditWorkout.week,
                        day: currentEditWorkout.day,
                        original_workout: currentEditWorkout.workout.workout,
                        original_miles: currentEditWorkout.workout.miles,
                        modified_workout: modifiedWorkout,
                        modified_miles: modifiedMiles,
                        modified_type: modifiedType,
                        modification_reason: modificationReason
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local data
                    const key = `w${currentEditWorkout.week}_d${currentEditWorkout.day}`;
                    completedWorkouts[key] = result.data;
                    
                    // Update stats FIRST
                    await updateStatsFromAPI();
                    
                    // THEN refresh view
                    renderView();
                    closeEditModal();
                } else {
                    alert('Error saving modification: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving edit:', error);
                alert('Error saving modification. Please try again.');
            }
        }

        // Revert to original workout
        async function revertToOriginal() {
            if (!currentEditWorkout) return;
            
            if (!confirm('Revert to original workout plan?')) return;
            
            try {
                const response = await fetch('/api/revert_workout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        week: currentEditWorkout.week,
                        day: currentEditWorkout.day
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update local data
                    const key = `w${currentEditWorkout.week}_d${currentEditWorkout.day}`;
                    completedWorkouts[key] = result.data;
                    
                    // Update stats FIRST
                    await updateStatsFromAPI();
                    
                    // THEN refresh view
                    renderView();
                    closeEditModal();
                } else {
                    alert('Error reverting: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error reverting:', error);
                alert('Error reverting. Please try again.');
            }
        }

// ============================================================================
        // STRAVA INTEGRATION
        // ============================================================================

        let stravaAuthorized = false;
        let stravaAthleteName = '';

        // Check Strava authorization status on page load
        async function checkStravaAuth() {
            try {
                const response = await fetch('/api/strava/check_auth');
                const data = await response.json();
                stravaAuthorized = data.authorized;
                stravaAthleteName = data.athlete_name || '';
                updateStravaStatus();
            } catch (error) {
                console.error('Error checking Strava auth:', error);
                stravaAuthorized = false;
                updateStravaStatus();
            }
        }

        function updateStravaStatus() {
            const statusEl = document.getElementById('strava-status');
            if (stravaAuthorized) {
                statusEl.innerHTML = `
                    <div class="flex items-center gap-2 bg-white bg-opacity-20 rounded px-3 py-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                        </svg>
                        <span class="text-sm">Strava Connected</span>
                    </div>
                `;
            } else {
                statusEl.innerHTML = `
                    <button onclick="authorizeStrava()" 
                        class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 px-3 py-2 rounded transition">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                        </svg>
                        <span class="text-sm">Connect Strava</span>
                    </button>
                `;
            }
        }

        async function authorizeStrava() {
            try {
                const response = await fetch('/api/strava/authorize');
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }
                
                // Open OAuth popup
                const width = 600;
                const height = 700;
                const left = (screen.width - width) / 2;
                const top = (screen.height - height) / 2;
                
                const popup = window.open(
                    data.auth_url,
                    'Strava Authorization',
                    `width=${width},height=${height},left=${left},top=${top}`
                );
                
                // Listen for auth success message
                window.addEventListener('message', async (event) => {
                    if (event.data.type === 'strava_auth_success') {
                        stravaAuthorized = true;
                        await checkStravaAuth();
                        alert('‚úÖ Strava connected successfully! You can now import workouts.');
                    }
                });
            } catch (error) {
                console.error('Error authorizing Strava:', error);
                alert('Failed to connect to Strava. Please try again.');
            }
        }

        async function importFromStrava(dayStr, week, dayIdx) {
            // Check if authorized
            if (!stravaAuthorized) {
                if (confirm('You need to connect Strava first. Connect now?')) {
                    authorizeStrava();
                }
                return;
            }
            
            try {
                // Parse date from day string (e.g., "Mon 12/1" -> "2025-12-01")
                const dateMatch = dayStr.match(/(\d+)\/(\d+)/);
                if (!dateMatch) {
                    alert('Could not parse date from: ' + dayStr);
                    return;
                }
                
                const month = dateMatch[1].padStart(2, '0');
                const day = dateMatch[2].padStart(2, '0');
                // Determine year based on month (Dec 2025, Jan-Feb 2026)
                const year = parseInt(month) === 12 ? '2025' : '2026';
                const isoDate = `${year}-${month}-${day}`;
                
                console.log('Fetching Strava activities for:', isoDate);
                
                // Show loading message
                showLoadingMessage('üîÑ Fetching Strava activities...');
                
                // Fetch activities for this date
                const response = await fetch(`/api/strava/activities/${isoDate}`);
                const data = await response.json();
                
                hideLoadingMessage();
                
                if (!response.ok) {
                    alert(`Error: ${data.error || 'Failed to fetch activities'}`);
                    return;
                }
                
                if (data.count === 0) {
                    alert('No runs found on Strava for ' + dayStr + '. Make sure you\'ve uploaded your activity!');
                    return;
                }
                
                console.log('Found', data.count, 'runs:', data.runs);
                
                // If multiple runs, let user choose
                let selectedRun;
                if (data.runs.length === 1) {
                    selectedRun = data.runs[0];
                } else {
                    selectedRun = await showStravaRunSelection(data.runs);
                    if (!selectedRun) return; // User cancelled
                }
                
                // Import the selected activity
                await importStravaActivity(selectedRun, week, dayIdx, dayStr);
                
            } catch (error) {
                console.error('Error importing from Strava:', error);
                hideLoadingMessage();
                alert('Failed to import from Strava: ' + error.message);
            }
        }

        async function importStravaActivity(activity, week, dayIdx, dayStr) {
            try {
                console.log('Importing activity:', activity);
                
                // Set current workout context
                currentWorkoutDate = {week, day: dayIdx};
                
                // Fill in the form
                document.getElementById('actual-distance').value = activity.distance;
                document.getElementById('duration').value = activity.duration;
                
                // Build notes with Strava data
                let notes = `üì≤ Imported from Strava: ${activity.name}\n`;
                if (activity.total_elevation_gain > 0) {
                    notes += `‚õ∞Ô∏è Elevation: ${activity.total_elevation_gain} ft\n`;
                }
                if (activity.average_heartrate) {
                    notes += `‚ù§Ô∏è Avg HR: ${activity.average_heartrate} bpm`;
                    if (activity.max_heartrate) {
                        notes += ` (Max: ${activity.max_heartrate})`;
                    }
                    notes += '\n';
                }
                document.getElementById('workout-notes').value = notes;
                
                // Trigger pace calculation
                calculatePace();
                
                // Update modal header
                document.getElementById('modal-workout-info').innerHTML = `
                    <p class="text-lg font-semibold text-gray-800">${dayStr}</p>
                    <p class="text-orange-600 mt-1 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                        </svg>
                        ${activity.name}
                    </p>
                `;
                
                // Show modal
                document.getElementById('workout-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error importing activity:', error);
                alert('Failed to import activity details');
            }
        }

        async function showStravaRunSelection(runs) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.id = 'strava-selection-modal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <svg class="w-5 h-5 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169"/>
                            </svg>
                            Select Strava Activity
                        </h3>
                        <div class="text-sm text-gray-600 mb-4">Found ${runs.length} runs for this day:</div>
                        <div class="space-y-2 mb-4">
                            ${runs.map((run, idx) => `
                                <button 
                                    onclick="window.selectStravaRun(${idx})"
                                    class="w-full text-left p-4 border-2 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition">
                                    <div class="font-semibold text-gray-900">${run.name}</div>
                                    <div class="text-sm text-gray-600 mt-1">
                                        üìè ${run.distance} mi ‚Ä¢ ‚è±Ô∏è ${run.duration} ‚Ä¢ üìä ${run.pace}
                                    </div>
                                    ${run.total_elevation_gain > 0 ? `<div class="text-xs text-gray-500 mt-1">‚õ∞Ô∏è ${run.total_elevation_gain} ft elevation</div>` : ''}
                                </button>
                            `).join('')}
                        </div>
                        <button 
                            onclick="window.closeStravaSelection()" 
                            class="w-full py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                            Cancel
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                window.selectStravaRun = (idx) => {
                    const run = runs[idx];
                    modal.remove();
                    resolve(run);
                };
                
                window.closeStravaSelection = () => {
                    modal.remove();
                    resolve(null);
                };
            });
        }

        function showLoadingMessage(message) {
            const existing = document.getElementById('loading-message');
            if (existing) existing.remove();
            
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loading-message';
            loadingMsg.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
            loadingMsg.innerHTML = `
                <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>${message}</span>
            `;
            document.body.appendChild(loadingMsg);
        }

        function hideLoadingMessage() {
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.remove();
        }

        // Initialize Strava on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkStravaAuth();
        });

    </script>
</body>
</html>
